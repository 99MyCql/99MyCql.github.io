<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/golang32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/golang16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-RpvRDWfflk">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.dounine.live","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="0. 前言如果说比特币是区块链1.0，那以太坊就是区块链2.0。比特币的出现，让大规模、去中心化的电子货币交易成为可能。而以太坊的出现，让任何人都能构建去中心化的合约与应用。根据白皮书的标题，我们也可以清晰地知道：比特币的核心是点对点电子货币，而以太坊的核心是智能合约与去中心化应用。">
<meta property="og:type" content="article">
<meta property="og:title" content="区块链2.0——以太坊">
<meta property="og:url" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A.html">
<meta property="og:site_name" content="dounine&#39;s blog">
<meta property="og:description" content="0. 前言如果说比特币是区块链1.0，那以太坊就是区块链2.0。比特币的出现，让大规模、去中心化的电子货币交易成为可能。而以太坊的出现，让任何人都能构建去中心化的合约与应用。根据白皮书的标题，我们也可以清晰地知道：比特币的核心是点对点电子货币，而以太坊的核心是智能合约与去中心化应用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_Lwh1MdIhBt.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_8I3tSzL9Ma.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_9Ahd_bsSmf.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_RJts9bGaXG.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_EQCCBPVEI0.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_G7DHhNvFQK.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_monpTD7cZ-.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_v6dQXBRZUQ.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_y9T_KSBzSy.png">
<meta property="og:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_35mtf8Vr94.png">
<meta property="article:published_time" content="2022-05-17T09:13:31.000Z">
<meta property="article:modified_time" content="2022-05-17T09:13:31.000Z">
<meta property="article:author" content="dounine">
<meta property="article:tag" content="区块链">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_Lwh1MdIhBt.png">


<link rel="canonical" href="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A.html","path":"区块链2-0——以太坊.html","title":"区块链2.0——以太坊"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>区块链2.0——以太坊 | dounine's blog</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?66c7065aa71681df47eb23eff557978b"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">dounine's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">18</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">50</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">84</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0-%E5%89%8D%E8%A8%80"><span class="nav-text">0. 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%AF%94%E7%89%B9%E5%B8%81%E5%9B%9E%E9%A1%BE"><span class="nav-text">1. 比特币回顾</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB%E7%B3%BB%E7%BB%9F"><span class="nav-text">状态转移系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC"><span class="nav-text">脚本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E8%B4%A6%E6%88%B7"><span class="nav-text">2. 账户</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E7%B1%BB%E5%9E%8B"><span class="nav-text">账户类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E5%AD%97%E6%AE%B5"><span class="nav-text">账户字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E5%9C%B0%E5%9D%80"><span class="nav-text">账户地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E5%AD%98%E5%82%A8%E2%80%94%E2%80%94%E7%8A%B6%E6%80%81%E6%A0%91"><span class="nav-text">账户存储——状态树</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E4%BA%A4%E6%98%93"><span class="nav-text">3. 交易</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF"><span class="nav-text">交易信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%EF%BC%88%E4%B8%80%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%89"><span class="nav-text">消息（一种特殊的交易）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C"><span class="nav-text">交易执行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%8C%BA%E5%9D%97"><span class="nav-text">4. 区块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E5%A4%B4"><span class="nav-text">区块头</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%BA%E5%9D%97%E9%AA%8C%E8%AF%81"><span class="nav-text">区块验证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E5%85%B1%E8%AF%86"><span class="nav-text">5. 共识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8EPoW"><span class="nav-text">工作量证明PoW</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8AGHOST"><span class="nav-text">以太坊GHOST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8C%96%E7%9F%BF%E7%AE%97%E6%B3%95ETHASH"><span class="nav-text">以太坊挖矿算法ETHASH</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E7%9B%8A%E8%AF%81%E6%98%8EPoS"><span class="nav-text">权益证明PoS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6"><span class="nav-text">6. 智能合约</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%88%E7%BA%A6%E5%88%9B%E5%BB%BA-x2F-%E9%83%A8%E7%BD%B2"><span class="nav-text">合约创建&#x2F;部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%88%E7%BA%A6%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-text">合约代码执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB"><span class="nav-text">重入攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E5%8F%8D%E6%80%9D"><span class="nav-text">7. 反思</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%80%BB%E7%BB%93"><span class="nav-text">8. 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dounine"
      src="https://avatars.githubusercontent.com/u/41814469?s=400&u=48bf60a3428a3cb86a84a110c8688930cf6ceb08&v=4">
  <p class="site-author-name" itemprop="name">dounine</p>
  <div class="site-description" itemprop="description">回首向来萧瑟处</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">84</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/99MyCql" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;99MyCql" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://bkfish.gitee.io/" title="https:&#x2F;&#x2F;bkfish.gitee.io&#x2F;" rel="noopener" target="_blank">bkfish</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://hitworld.github.io/" title="https:&#x2F;&#x2F;hitworld.github.io&#x2F;" rel="noopener" target="_blank">w4rd3n</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wyjoutstanding.github.io/" title="https:&#x2F;&#x2F;wyjoutstanding.github.io&#x2F;" rel="noopener" target="_blank">wyjoutstanding</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://iwtf.github.io/" title="https:&#x2F;&#x2F;iwtf.github.io&#x2F;" rel="noopener" target="_blank">IWTF</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://wood1314.github.io/" title="https:&#x2F;&#x2F;wood1314.github.io&#x2F;" rel="noopener" target="_blank">wood</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://desperadoccy.xyz/" title="https:&#x2F;&#x2F;desperadoccy.xyz&#x2F;" rel="noopener" target="_blank">desperadoccy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://doudouqaq.github.io/" title="https:&#x2F;&#x2F;doudouqaq.github.io&#x2F;" rel="noopener" target="_blank">doudouqaq</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://kylinnnnn.github.io/" title="https:&#x2F;&#x2F;kylinnnnn.github.io&#x2F;" rel="noopener" target="_blank">kylinnnnn</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://miaotony.xyz/" title="https:&#x2F;&#x2F;miaotony.xyz" rel="noopener" target="_blank">miaotony</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://110.40.153.120:3030/" title="http:&#x2F;&#x2F;110.40.153.120:3030&#x2F;" rel="noopener" target="_blank">AZhou</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/weixin_40986490" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_40986490" rel="noopener" target="_blank">白速龙王的回眸</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/weixin_43116322" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_43116322" rel="noopener" target="_blank">Ethan</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.dounine.live/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/41814469?s=400&u=48bf60a3428a3cb86a84a110c8688930cf6ceb08&v=4">
      <meta itemprop="name" content="dounine">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dounine's blog">
      <meta itemprop="description" content="回首向来萧瑟处">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="区块链2.0——以太坊 | dounine's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          区块链2.0——以太坊
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-17 17:13:31" itemprop="dateCreated datePublished" datetime="2022-05-17T17:13:31+08:00">2022-05-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Pro/" itemprop="url" rel="index"><span itemprop="name">欲穷千里目，更上一层楼</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Pro/BlockChain/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>如果说比特币是区块链1.0，那以太坊就是区块链2.0。比特币的出现，让大规模、去中心化的电子货币交易成为可能。而以太坊的出现，让任何人都能构建去中心化的合约与应用。根据白皮书的标题，我们也可以清晰地知道：比特币的核心是点对点电子货币，而以太坊的核心是智能合约与去中心化应用。</p>
<span id="more"></span>

<h1 id="1-比特币回顾"><a href="#1-比特币回顾" class="headerlink" title="1. 比特币回顾"></a>1. 比特币回顾</h1><h2 id="状态转移系统"><a href="#状态转移系统" class="headerlink" title="状态转移系统"></a>状态转移系统</h2><p>在以太坊白皮书中提到，从技术角度，比特币就是一个状态转移系统(state transition system)。状态是系统中各个账户的剩余比特币，准确一点，是各账户的UTXO。每当成功发生一笔交易，就是从一个状态转移到一个新的状态。比如，状态1中A有10个币B有2个币，发生一笔交易A→B 5个币，就会转移到状态2（A有5个币，B有7个币）。</p>
<blockquote>
<p>From a technical standpoint, the ledger of a cryptocurrency such as Bitcoin can be thought of as a state transition system, where there is a “state” consisting of the ownership status of all existing bitcoins and a “state transition function” that takes a state and a transaction and outputs a new state which is the result.</p>
</blockquote>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>在比特币中，存在一个弱化版的智能合约——交易脚本。交易脚本除了能实现基本的交易验证功能之外，还能实现一些稍微复杂的功能，比如：多重签名，需要3个公私钥账户中2个的签名，才能完成验证。</p>
<p>但比特币中的脚本语言存在一定的局限性，比如：<strong>缺乏图灵完备性</strong>。无法直接循环运算，这样做是避免交易验证时出现无限循环。</p>
<h1 id="2-账户"><a href="#2-账户" class="headerlink" title="2. 账户"></a>2. 账户</h1><p>比特币是<strong>基于交易</strong>的记账系统，当统计某个账户(地址)有多少币时，需要遍历区块链上该账户的未花费币，即UTXO。而以太坊是<strong>基于账户</strong>的记账系统，全节点会保存系统中所有账户的信息，可以直观地看到账户的余额。</p>
<p>为什么要使用基于账户的记账系统？因为以太坊的核心在于智能合约，为了方便智能合约的制定与执行，需要依靠账户系统。</p>
<p>相比于基于交易，基于账户的记账系统<strong>不用考虑双花攻击</strong>。因为不需要指向上一笔交易，付款金额从账户中扣除，若付款方将同一笔交易公布两次，相当于花了自己两笔钱。但是，基于账户的系统会出现<strong>重放攻击</strong>，即收款方将同一笔交易再次公布，以此收取两笔钱。为了解决这个问题，以太坊为每个账户保存一个记录交易数量的值nonce，并在交易中包含一个序号，规定序号大于nonce时交易才有效。</p>
<h2 id="账户类型"><a href="#账户类型" class="headerlink" title="账户类型"></a>账户类型</h2><p>以太坊中包含两类账户：</p>
<ul>
<li><p>**外部持有账户(externally owned accounts)**，即普通账户，自行产生公私钥加入系统。</p>
</li>
<li><p>**合约账户(contract accounts)**，用于智能合约。</p>
</li>
</ul>
<h2 id="账户字段"><a href="#账户字段" class="headerlink" title="账户字段"></a>账户字段</h2><p>以太坊帐户有四个字段：</p>
<ul>
<li><p><code>nonce</code> - 记录从帐户发起的交易数量，即交易数量计数器，初始化为0。这确保交易只处理一次，防止重放攻击。在合约帐户中，这个数字代表该帐户创建的合约数量(?)。</p>
</li>
<li><p><code>balance</code> - 账户余额，拥有的Wei数量(1 ETH&#x3D;1e+18 Wei)。</p>
</li>
<li><p><code>codeHash</code> - 合约帐户所拥有的代码片段。所有代码片段都被保存在状态数据库的相应哈希下，供后续检索。对于普通帐户，该字段为空。</p>
</li>
<li><p><code>storageRoot</code> - 存储合约账户的相关状态，其值是Merkle Patricia trie根节点的哈希值。</p>
</li>
</ul>
<h2 id="账户地址"><a href="#账户地址" class="headerlink" title="账户地址"></a>账户地址</h2><p>用户先随机生成一个私钥，通过椭圆曲线算法生成公钥，再通过Keccak-256哈希生成256位的数，取最后160位（20个字节）作为账户地址。</p>
<h2 id="账户存储——状态树"><a href="#账户存储——状态树" class="headerlink" title="账户存储——状态树"></a>账户存储——状态树</h2><p>虽然账户带来了便利，但也制造了一些麻烦：每个全节点需要保存各个账户的状态，同时还要对这些账户状态达成共识。为此，以太坊使用了一种Merkle Patricia trie(MPT)的数据结构，对账户状态进行存储。存储账户状态的这棵MPT，又被称为状态树。</p>
<p>Merkle Patricia trie的由来如下：</p>
<ol>
<li>trie: 字典树&#x2F;前缀树</li>
</ol>
<p>  <img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_Lwh1MdIhBt.png" alt="1"></p>
<ol start="2">
<li>Patricia trie: 经路径压缩的前缀树</li>
</ol>
<p>  <img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_8I3tSzL9Ma.png" alt="1"></p>
<ol start="3">
<li><p>Merkle Patricia trie: 使用哈希指针的Patricia trie</p>
</li>
<li><p>Modified Merkle Patricia trie: 以太坊中所使用的，做了稍许修改</p>
</li>
</ol>
<p>  <img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_9Ahd_bsSmf.png" alt="1"></p>
<p>为什么不使用hash表？账户地址与状态有着明显的一对一关系，若使用hash表，查找、增加、更新都是O(1)时间复杂度。但是，hash表不利于达成共识。为了保证各节点之间账户状态的一致性，每次都在发布区块中包含所有账户的状态是不可能的。而常用方法是：取一个总哈希值，每次发布区块时，各节点对这个哈希值达成共识。然而，每次生成区块，都会有账户状态发生变化，那就需要对所有账户重新取哈希，工作量极大。</p>
<p>为什么不使用Merkle树？使用默克尔树结构的好处在于：账户状态发生更新时，只需要更新对应叶子节点到根节点路径上的哈希值。但是，默克尔树对新增账户并不友好。在叶子节点中，不同的排序会产生不同的根哈希值。如果按照账户地址排序，那么新增账户的地址有可能在序列的中间，将导致大半棵树重新计算。</p>
<p>为什么使用MPT树？账户地址等长，20个字节，用16进制表示则有40个字符，那么树最大高度就是40，查询复杂度并不高。账户更新时，只需更新到根节点路径上的哈希值即可。新增账户时，不会影响其它账户，也只用更新到根节点路径上的哈希值。<strong>发布区块时，只需在区块体中包含变化账户的信息，大家会对区块头中状态树的根节点哈希值达成共识。</strong></p>
<p>同时，以太坊中还有另外两棵树——<strong>交易树</strong>和<strong>收据树</strong>，它们都采用MPT的数据结构。收据是交易执行后产生的信息，与交易一一对应，用于智能合约。交易树和收据树都只包含当前区块中的交易数据，而非全部。</p>
<h1 id="3-交易"><a href="#3-交易" class="headerlink" title="3. 交易"></a>3. 交易</h1><h2 id="交易信息"><a href="#交易信息" class="headerlink" title="交易信息"></a>交易信息</h2><p>交易(Transactions)是由<strong>外部持有账户（即普通账户）发送的</strong>，包含如下信息：</p>
<ul>
<li><p><code>recipient</code> - 接收地址，可以是普通账户，<strong>也可以是合约账户</strong>。</p>
</li>
<li><p><code>signature</code> - 发送者的签名。</p>
</li>
<li><p><code>value</code> - 交易的金额，以Wei为单位。</p>
</li>
<li><p><code>data</code> - 一些可选的数据字段。</p>
</li>
<li><p><code>STARTGAS</code> - 表示允许交易执行的最大计算步骤数（当实际计算步骤大于这个值时，交易将不会被执行），单位是gas。通常一个计算步骤花费1gas或者更多。</p>
</li>
<li><p><code>GASPRICE</code> - 表示支付方为每个计算步骤支付的费用，即每个gas需支付多少以太币。</p>
</li>
</ul>
<p>汽油费Gas是一个单位，用于衡量交易执行所消耗的资源。</p>
<p>以太坊规定，交易执行所导致的每个计算、存储都需要消耗费用，而设计gas限额是为了防止恶意者发布无限循环代码或者浪费计算资源。</p>
<h2 id="消息（一种特殊的交易）"><a href="#消息（一种特殊的交易）" class="headerlink" title="消息（一种特殊的交易）"></a>消息（一种特殊的交易）</h2><p>消息(Messages)由<strong>合约账户向另一个合约账户</strong>发送，包含如下信息：</p>
<ul>
<li><p>消息的发送者（隐含）</p>
</li>
<li><p>消息的接收者</p>
</li>
<li><p>与消息一起传输的ether数量</p>
</li>
<li><p>一个可选的数据字段</p>
</li>
<li><p>一个<code>STARTGAS</code>值</p>
</li>
</ul>
<p>当正在执行的合约执行到<code>CALL</code>操作码时，就会产生一条消息。交易或合约指定的gas限额，适用于该交易和<strong>所有次级执行</strong>所消耗的总gas。例如，外部账户A向合约账户B发送了一笔1000 gas的交易，B已花费了600 gas，此时执行<code>CALL</code>指令向合约C发送消息，C执行完花费300 gas，那B还剩100 gas。</p>
<h2 id="交易执行"><a href="#交易执行" class="headerlink" title="交易执行"></a>交易执行</h2><ol>
<li><p>检查交易是否格式正确，签名是否有效，以及nonce是否与发送者帐户中的nonce匹配。</p>
</li>
<li><p>计算交易手续费&#x2F;汽油费&#x3D;<code>STARTGAS * GASPRICE</code>，并从签名中确定发送者账户。从发送者帐户的余额中减去这笔费用，并增加发送者的nonce。如果发送者没有足够的余额，则返回错误。</p>
</li>
<li><p>初始化<code>GAS = STARTGAS</code>，并先根据交易的字节数支付一定量的gas（存储也需消耗gas）。</p>
</li>
<li><p>将交易额从发送者帐户转移到接收者帐户。如果接收帐户尚不存在，就创建它。如果接收帐户是合约，则运行合约的代码，要么执行完成，要么gas被消耗完。</p>
</li>
<li><p>如果发送者账户没有足够的金额，或者代码执行耗尽了gas，或者出现错误，则<strong>回滚除了支付汽油费之外的所有状态</strong>，并将汽油费添加到矿工的帐户（<strong>已消耗的汽油费不退</strong>，防止恶意节点浪费资源）。</p>
</li>
<li><p>如果一切顺利执行完，则将<strong>剩余的gas费用退还给发送者</strong>，并将消耗的gas费用发送给矿工。</p>
</li>
</ol>
<p>举例：假设存在一个合约账户，初始状态中，存储为空，代码（实际上合约代码是用低级EVM代码编写的，这个例子是用Serpent编写的，这是以太坊的高级语言之一，可以被编译成EVM代码）如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> !self.storage[calldataload(<span class="number">0</span>)]:</span><br><span class="line">  self.storage[calldataload(<span class="number">0</span>)] = calldataload(<span class="number">32</span>)</span><br></pre></td></tr></table></figure>

<p>此时，有一笔交易发送到合约账户，它包含10 ether，2000 gas（gas价格是0.001个ether）和64个字节的数据，字节0-31存储着数字<code>2</code>，字节32-63存储着字符串<code>CHARLIE</code>。交易执行的过程如下：</p>
<ol>
<li><p>检查交易是否有效且格式正确。</p>
</li>
<li><p>检查交易发送者是否至少有2000*0.001 &#x3D; 2 ether。如果有，则从发送者的帐户中减去2 ether。</p>
</li>
<li><p>初始化gas&#x3D;2000。假设交易总长度是170字节，且每个字节的费用是5 gas，则减去170*5 &#x3D; 850 gas，还剩1150 gas。</p>
</li>
<li><p>从发送者的帐户中再减去10 ether，并将其添加到合约的帐户中。</p>
</li>
<li><p>运行代码。代码中<code>calldataload(i)</code>是取交易数据中字节i位置的值，因此代码的作用是：检查<code>self.storage[2]</code>存储中索引2处有没有值，若没有值，则将字符串<code>CHARLIE</code>存储到这。假设这需要187 gas，那么gas剩余1150 - 187 &#x3D; 963。</p>
</li>
<li><p>将963 * 0.001 &#x3D; 0.963 ether返回发送者帐户，并返回结果状态。</p>
</li>
</ol>
<p>如果交易是发送给普通账户的，那么交易手续费直接等于<code>GASPRICE</code> * 交易的字节长度。</p>
<p>另外，消息的回滚与交易的回滚一样。<strong>如果消息执行消耗完gas，消息的执行和其触发的次级执行都会回滚。但是，父级执行不会回滚。</strong></p>
<h1 id="4-区块"><a href="#4-区块" class="headerlink" title="4. 区块"></a>4. 区块</h1><h2 id="区块头"><a href="#区块头" class="headerlink" title="区块头"></a>区块头</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span> &#123;</span><br><span class="line">  ParentHash  common.Hash    <span class="string">`json:&quot;parentHash&quot;       gencodec:&quot;required&quot;`</span></span><br><span class="line">  UncleHash   common.Hash    <span class="string">`json:&quot;sha3Uncles&quot;       gencodec:&quot;required&quot;`</span></span><br><span class="line">  Coinbase    common.Address <span class="string">`json:&quot;miner&quot;            gencodec:&quot;required&quot;`</span></span><br><span class="line">  Root        common.Hash    <span class="string">`json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span></span><br><span class="line">  TxHash      common.Hash    <span class="string">`json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;`</span></span><br><span class="line">  ReceiptHash common.Hash    <span class="string">`json:&quot;receiptsRoot&quot;     gencodec:&quot;required&quot;`</span></span><br><span class="line">  Bloom       Bloom          <span class="string">`json:&quot;logsBloom&quot;        gencodec:&quot;required&quot;`</span></span><br><span class="line">  Difficulty  *big.Int       <span class="string">`json:&quot;difficulty&quot;       gencodec:&quot;required&quot;`</span></span><br><span class="line">  Number      *big.Int       <span class="string">`json:&quot;number&quot;           gencodec:&quot;required&quot;`</span></span><br><span class="line">  GasLimit    <span class="type">uint64</span>         <span class="string">`json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span></span><br><span class="line">  GasUsed     <span class="type">uint64</span>         <span class="string">`json:&quot;gasUsed&quot;          gencodec:&quot;required&quot;`</span></span><br><span class="line">  Time        <span class="type">uint64</span>         <span class="string">`json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span></span><br><span class="line">  Extra       []<span class="type">byte</span>         <span class="string">`json:&quot;extraData&quot;        gencodec:&quot;required&quot;`</span></span><br><span class="line">  MixDigest   common.Hash    <span class="string">`json:&quot;mixHash&quot;`</span></span><br><span class="line">  Nonce       BlockNonce     <span class="string">`json:&quot;nonce&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ParentHash - 父区块块头的哈希值</p>
</li>
<li><p>UncleHash - 叔叔区块块头的哈希值</p>
</li>
<li><p>Coinbase - 挖出区块矿工的地址</p>
</li>
<li><p>Root - 状态树的Hash</p>
</li>
<li><p>TxHash - 交易树的Hash</p>
</li>
<li><p>ReceiptHash -收据树的Hash</p>
</li>
<li><p>Bloom - 布隆过滤器，帮助轻节点筛选区块中是否存在需要的收据信息</p>
</li>
<li><p>Difficulty - 挖矿难度</p>
</li>
<li><p>Number - 区块序号</p>
</li>
<li><p>GasLimit - 区块中所有交易所消耗的gas总量必须低于该值。挖出区块的矿工可以对该值进行微调：$上一个区块的GasLimit \pm \frac{1}{1024}$ ，<strong>最终这个值会趋于一个大家都觉得合理的值</strong>。</p>
</li>
<li><p>GasUsed - 区块中所有交易实际消耗的gas总量</p>
</li>
<li><p>Time - 区块创建时间</p>
</li>
<li><p>Extra - 额外信息</p>
</li>
<li><p>MixDigest - 区块哈希</p>
</li>
<li><p>Nonce - 挖矿使用的随机数</p>
</li>
</ul>
<h2 id="区块验证"><a href="#区块验证" class="headerlink" title="区块验证"></a>区块验证</h2><ol>
<li><p>检查引用的前一个区块是否存在且有效。</p>
</li>
<li><p>检查区块的时间戳是否大于前一个区块的时间戳，并且比当前时刻不超过15分钟。</p>
</li>
<li><p>检查区块编号、难度、交易树根(transaction root)、叔叔区块根(uncle root)和gas限制是否有效。</p>
</li>
<li><p>检查区块上的工作量证明是否有效。</p>
</li>
<li><p>以前一个区块的状态为初始状态，依次执行区块中的交易。如果任何交易执行失败，或者消耗的总gas超过<code>GASLIMIT</code>，则返回错误。</p>
</li>
<li><p>若都执行成功，将出块奖励添加到矿工账户。</p>
</li>
<li><p>检查最终状态的Merkle树根是否等于区块头中提供的最终状态根。如果是，则该区块有效;否则，它无效。</p>
</li>
</ol>
<h1 id="5-共识"><a href="#5-共识" class="headerlink" title="5. 共识"></a>5. 共识</h1><h2 id="工作量证明PoW"><a href="#工作量证明PoW" class="headerlink" title="工作量证明PoW"></a>工作量证明PoW</h2><h3 id="以太坊GHOST"><a href="#以太坊GHOST" class="headerlink" title="以太坊GHOST"></a>以太坊GHOST</h3><p>比特币的平均出块时间为10分钟（通过挖矿难度控制），一笔交易被确认写入区块链需要1小时（6个区块），如此高的延迟对于日常交易是极其不便的。但如果出块时间过快，又会导致系统容易被攻击（比如双花攻击）。因为，<strong>区块在网络中传播需要时间，如果出块时间小于网络传播时间，就会导致算力分散（当新区块传播到对方时，对方的新区块甚至第二个新区块都已经产生了）</strong>。从而导致攻击者即使不够51%算力，也能发动攻击。如下图，攻击者A集中算力私自产生6个区块，即使它未超过系统总算力一半(6&#x2F;18)，也能超过最长链：</p>
<p><img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_RJts9bGaXG.png"></p>
<p><strong>GHOST（Greedy Heaviest Observed Subtree，贪婪的最重要的观察子树）</strong>协议由Yonatan Sompolinsky和Aviv Zohar于<a target="_blank" rel="noopener" href="https://eprint.iacr.org/2013/881.pdf" title="2013年12月">2013年12月</a>首次推出，是一种<strong>主链选择协议</strong>，为了解决出块时间缩短导致系统不安全的问题。它在选取主链时，不是根据长度，而是根据<strong>子树中区块的数量</strong>，因此GHOST也可被称为最重子树原则。如上图，面对1B和1A的分叉，GHOST会选择1B，因为1B所在子树中区块数量更多，接着选择2C→3D→4B。</p>
<p>比特币中还存在一大问题：算力中心化。时至今日，最大的矿池已占系统总算力的30%。当出块时间过快时，大矿池可能主导挖矿过程。进而导致其它矿工的算力被浪费，无法获得奖励，其积极性也被打压。</p>
<p>以太坊在GHOST协议上作出修改，既保证主链的安全，又使得与主链相连的孤块也能获取收益。具体定义如下：</p>
<ul>
<li><p>区块必须指定父区块，同时还可以指定0-2个叔叔区块。</p>
</li>
<li><p>区块<code>B</code>中指向的叔叔区块必须具有以下属性：</p>
</li>
<li><p>它必须是<code>B</code>的第<code>k</code>代祖先的直接子区块，其中<code>2 &lt;= k &lt;= 7</code>（注：第1代祖先指自己，第2代祖先指父区块，第3代祖先指爷爷区块）。</p>
</li>
<li><p>它不能是<code>B</code>的祖先。</p>
</li>
<li><p>叔叔区块必须是有效的区块头，但<strong>不需要是先前验证、甚至有效的区块，区块中交易不需要执行</strong>。</p>
</li>
<li><p>叔叔区块不能被双重包含。</p>
</li>
<li><p>对于区块<code>B</code>包含的每个叔叔区块，<code>B</code>的矿工获得额外1&#x2F;32的出块奖励，叔叔区块的矿工获得的<code>(8-k+1)/8</code>出块奖励（注：父区块的子区块获得7&#x2F;8奖励，爷爷区块的子区块获得6&#x2F;8，直到2&#x2F;8）。</p>
</li>
</ul>
<p>上述定义的作用：</p>
<ol>
<li><p>避免算力中心化，激发个体矿工积极性。</p>
</li>
<li><p>鼓励大家沿着主链挖矿而不是攻击链（即便攻击链更长，但主链上叔叔区块更多），从而<strong>达到GHOST<strong><strong>选择</strong></strong>最重子树的效果</strong>。</p>
</li>
</ol>
<p>为什么规定7代之内的叔叔区块才有奖励？因为不限制的话，有可能包含前100代的叔叔区块，那全节点要保存的区块数据将非常庞大（因为要验证叔叔区块不能被重复包含）。</p>
<h3 id="以太坊挖矿算法ETHASH"><a href="#以太坊挖矿算法ETHASH" class="headerlink" title="以太坊挖矿算法ETHASH"></a>以太坊挖矿算法ETHASH</h3><p>比特币中，矿工通过不断调整区块头数据，并用SHA256计算区块头哈希，使区块哈希小于目标难度值，从而达成工作量证明，即成功挖出区块。随着比特币的飞速发展，挖矿过程逐渐<strong>专业化和中心化</strong>。首先，挖矿的芯片已由普通CPU转向了ASIC等专业芯片。其次，挖矿越来越趋于中心化，依赖于中心化矿池，排名前几的矿池已拥有超过系统50%的算力。普通人难以参与到挖矿过程中，这显然违背了中本聪创建比特币时”one-CPU-one-vote”的初衷。</p>
<p>为了抵制专用芯片导致的挖矿专业化，一种方法是设计<strong>Memory-Hard(花费大量内存)挖矿算法</strong>：在挖矿时不仅要考虑算力，还需考虑内存。因为，专业挖矿芯片的哈希计算能力强，但内存访问效率并不高。如果在挖矿算法中不仅要求计算哈希，还需要不断访问内存，<strong>算法瓶颈就会受内存访问速率的限制（冯诺依曼体系的问题）</strong>。那会不会出现计算能力和内存访问都高效的新设备呢？会，但不会像ASIC芯片那样拥有极高的哈希计算能力，因为受制于内存访问速率。而如果能让内存访问速度和芯片计算速度一样，那将是计算机领域的重大突破。目前，以太坊主要是使用GPU和部分专业矿机挖矿，而比特币只能使用专业矿机挖矿，这说明ETHASH能一定程度上抵制专业矿机，但无法杜绝挖矿越来越卷。</p>
<p>设计Memory-Hard算法还需考虑的一个问题是：<strong>如何方便轻节点验证？</strong>如果内存要求太大，轻节点将无法验证（轻节点内存有限）。而如果要求太小，又起不到明显的抵制作用（缓存可以解决）。莱特币也采用了Memory-Hard挖矿算法，但只要求168K的内存，最终并未起到显著效果。但莱特币凭借着可抵制专业矿机的宣传，解决了<strong>冷启动问题</strong>（货币初期没人使用的问题）。</p>
<p>为了既能保证Memory-Hard，又方便轻节点验证，以太坊设计了挖矿算法<strong>ETHASH</strong>。算法过程如下：</p>
<p>算法初始化：</p>
<ul>
<li><p>通过一个seed种子生成一个16MB的缓存数组cache：cache[0]&#x3D;keccak512(seed)，cache[i]&#x3D;keccak512(cache[i-1])，<strong>keccak512</strong>是第三代哈希算法(SHA-3)。</p>
</li>
<li><p>再根据缓存数组生成一个1GB的数据集数组dataset，也被称为DAG。数组中第i个元素的生成过程如下：</p>
</li>
</ul>
<p>  <img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_EQCCBPVEI0.png"></p>
<ul>
<li>每隔30000个区块，seed会重新生成，缓存数组和数据集数组的大小也会增大一次，增大初始大小的1&#x2F;128。</li>
</ul>
<p>dataset数组用于全节点挖矿，cache数组用于轻节点验证。dataset数组中每个元素都可通过cache数组计算生成。全节点挖矿时，需要不断计算区块哈希，而计算区块哈希又需要频繁访问dataset数组，<strong>为了节省时间，全节点会在内存中保存dataset数组</strong>。而轻节点验证时，只需计算一次区块哈希，则可<strong>临时</strong>通过cache数组计算出dataset数组中相应位置的值。挖矿和验证的伪代码如下：</p>
<p><img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_G7DHhNvFQK.png"></p>
<p>为什么要抵制ASIC专业矿机？为了让普通计算机也参与到系统中，参与的计算机越多越能保证系统的安全性。但也有人认为专业矿机更能保证系统安全，因为攻击者想要攻击系统必须购买专业矿机，而专业矿机只适用于某一种加密货币，无法通用。因此攻击者发动攻击的成本更高，如果攻击失败，矿机只能挖矿或出售；如果攻击成功，加密货币声誉受损、价值暴跌，矿机又没用了。</p>
<p>值得一提的是，ETHASH算法仍属于PoW范畴，而以太坊已计划向PoS转移。</p>
<h2 id="权益证明PoS"><a href="#权益证明PoS" class="headerlink" title="权益证明PoS"></a>权益证明PoS</h2><p>工作量证明(PoW)是由中本聪提出的一种共识机制，已在比特币中得到充分的安全性验证。但它消耗大量电力资源的问题，也被广为诟病。<strong>权益证明机制(Proof of Stake, PoS)</strong> 是一种新的共识机制，它根据参与者的权益（比如持有币的数量）投票达成共识（类似于股份制），大幅减少电力消耗。以太坊将要使用的PoS算法为：<strong>Casper</strong>，但目前依旧处于探索阶段。</p>
<p>对于PoW的电力消耗，存在另一种声音：挖矿所消耗的电力并不算太大，同时很多发电厂产生的电力并不能被充分使用，甚至被浪费。而大部分矿池修建在发电厂旁边，能够更好将电力转换为金钱。</p>
<h1 id="6-智能合约"><a href="#6-智能合约" class="headerlink" title="6. 智能合约"></a>6. 智能合约</h1><p>在以太坊中，智能合约是一种账户，拥有余额也能发送交易。此外，合约账户还拥有<code>code</code>字段（用于存储代码）和<code>storage</code>字段（用于存储数据）。<strong>用户可以通过向合约发送交易，来执行合约中的相关代码</strong>。</p>
<h2 id="合约创建-x2F-部署"><a href="#合约创建-x2F-部署" class="headerlink" title="合约创建&#x2F;部署"></a>合约创建&#x2F;部署</h2><p>智能合约可先由Solidity、Vyper等高级语言编写，再编译成字节码（EVM代码，类似汇编代码），然后才能部署到以太坊上。当部署合约时，<strong>外部账户发起一笔收款地址为0x0的转账交易，并将编译好的合约代码放在交易的data域中</strong>。交易的转账金额是0，但需支付gas汽油费。当交易被成功写入区块链时，就意味着合约被成功创建。</p>
<h2 id="合约代码执行"><a href="#合约代码执行" class="headerlink" title="合约代码执行"></a>合约代码执行</h2><p>合约账户保存的代码是由基于堆栈的字节码语言编写的，是一种低级语言，被称为“以太坊虚拟机代码”或“EVM代码”。EVM代码就像一个字节数组，<strong>每个字节可表示一个操作码，每个操作都会消耗一定量的汽油费(gas)。</strong> 比如操作码<code>ADD</code>，将栈顶两个元素弹出并相加，消耗3 gas。代码会依次执行，每次执行程序计数器(pc)都会加1，直到代码结束、或遇到错误、或执行到<code>STOP/RETURN</code>指令。</p>
<p>代码可以访问的数据空间：</p>
<ul>
<li><p><strong>堆栈</strong>，栈。</p>
</li>
<li><p><strong>内存</strong>，一个无限可扩展的字节数组。</p>
</li>
<li><p>合约的<strong>存储</strong>，键&#x2F;值存储。与堆栈和内存不同，堆栈和内存在计算结束后重置，而存储会持久化。</p>
</li>
<li><p>消息的金额值、发送者、数据，以及区块头数据</p>
</li>
</ul>
<p>代码可以返回数据的字节数组作为输出。</p>
<p>注意：</p>
<ul>
<li><p>为了保证一致性，<strong>智能合约不支持多线程</strong>。因为不同线程对内存访问顺序不一致的话，执行结果可能不一致。</p>
</li>
<li><p>智能合约的代码**一旦发布就不能修改(code is law)**，好处是谁也无法修改规则，坏处是无法修复漏洞。</p>
</li>
</ul>
<h2 id="重入攻击"><a href="#重入攻击" class="headerlink" title="重入攻击"></a>重入攻击</h2><p>一个用于拍卖的智能合约代码示例：</p>
<p><img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_monpTD7cZ-.png"></p>
<p><img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_v6dQXBRZUQ.png"></p>
<p>其中，withdraw函数由投标者调用，用于取回出价。函数代码中，<code>msg.sender.call.value(amount)</code>是向消息的发送方（也就是代码的调用者）发送amount数量的以太币。</p>
<p>代码逻辑初看没有问题，但却存在致命漏洞。攻击者先创建一个合约账户HackV2，在账户的代码中定义<strong>fallback函数（匿名函数，当向合约地址转账而不指定函数时，或指定函数不存在时，fallback函数会被调用）</strong>，并在fallback函数中调用拍卖合约的withdraw函数。然后，攻击者就可以发动攻击：</p>
<ol>
<li><p>攻击者以合约账户HackV2的身份加入拍卖；</p>
</li>
<li><p>拍卖结束后，攻击者通过合约账户HackV2的hack_withdraw函数，调用拍卖合约中的withdraw函数取回自己的出价。当withdraw函数执行到<code>msg.sender.call.value(amount)</code>时，会向HackV2账户发送一笔转账交易，交易会触发HackV2的fallback函数。而fallback函数又会调用拍卖合约中withdraw向自己转账，如此无限递归调用，直到gas汽油费被耗尽。如此，攻击者将获得数倍于出价的金额。</p>
</li>
</ol>
<p><img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_y9T_KSBzSy.png"></p>
<p>出现这个漏洞的原因是：withdraw函数先转账再将对应账户的余额置为0，而转账操作可以触发无限递归。正确的写法是先将账户余额置为0再转账，修改如下：</p>
<p><img src="/%E5%8C%BA%E5%9D%97%E9%93%BE2-0%E2%80%94%E2%80%94%E4%BB%A5%E5%A4%AA%E5%9D%8A/image_35mtf8Vr94.png"></p>
<p>2016年，以太坊发生著名的**“The DAO”事件**，其原因就是黑客对合约发动重入攻击。为了挽救损失，以太坊社区决定发动硬分叉回滚：开发团队发布以太坊新版本，在代码中强制The DAO合约相关账户的钱转到另一个合约，甚至不需要私钥。但由于部分人不赞成这种回滚，从而导致以太币分化成两个版本ETH和ETC，延续至今。</p>
<h1 id="7-反思"><a href="#7-反思" class="headerlink" title="7. 反思"></a>7. 反思</h1><p>肖老师课程倒数第二节内容：</p>
<ul>
<li><p>Is smart contract really smart?</p>
</li>
<li><p>Irrevocability is a double edged sword.</p>
</li>
<li><p>Noting is irrevocability.</p>
</li>
<li><p>Is solidity the right programming language?</p>
</li>
<li><p>What is decentralize mean? 在The DAO事件中，部分人为了去中心化信仰，拒绝硬分叉。但硬分叉真的破坏了去中心化吗？以太坊开发团队虽然能发布升级，但最终实现硬分叉是因为<strong>大部分矿工同意更新</strong>，以太坊团队<strong>并不能强制矿工执行</strong>。所以，这还是一个去中心化的过程。</p>
</li>
</ul>
<blockquote>
<p>去中心化的规则并不是不能修改，而是要用去中心化的方法来完成。分叉恰恰是民主的一种体现。</p>
</blockquote>
<ul>
<li><p>decentralized ≠distributed。去中心必定是分布式，但分布式不一定去中心化。</p>
</li>
<li><p>以太坊虽然能实现大规模分布式一致性，但性能并不高。所以它<strong>并不适用于大规模计算和存储</strong>，而更适用于编写关键逻辑。</p>
</li>
</ul>
<h1 id="8-总结"><a href="#8-总结" class="headerlink" title="8. 总结"></a>8. 总结</h1><p>13岁的V神沉迷暴雪公司的魔兽世界，可是有一天暴雪公司把他很喜欢的一个技能删除了，他多次发邮件反应，但都得不到想要的答复。V神很气愤，凭什么暴雪公司不征求用户意见，想删除就删除。怀揣着对这种中心化公司任性行为的不满，V神在他19岁那年，发布了以太坊白皮书，开创了区块链2.0时代。</p>
<p>比特币开创了区块链时代，但它仅仅实现了交易的去中心化。而以太坊让各式各样的去中心化应用成为可能，去中心化的拍卖、去中心化的慈善募捐、去中心化的投资等等。以太坊的出现，吸引了许多像V神这样对中心化不满的人们，他们从以太坊上看到了去中心化的光明未来。但随着热潮褪去，随着The DAO等安全事件的发生，我们发现去中心化还有很长的路要走，我们也不能盲目地推崇去中心化。</p>
<p>去中心化一定是万能的吗？去中心化一定好吗？去中心化与中心化一定是非黑即白的吗？去中心化意味着民主，但也存在效率低下、决策正确性等问题。而在一些场景，中心化已经表现得很好，就不必使用去中心化了，比如：在奶茶店买一杯奶茶，使用微信付款只需片刻，而若使用比特币你将等待1个小时。另外，对于The DAO这种去中心化风投，其效益还真不一定比中心化的专业风投机构高。其实，中心化与去中心化并不互斥，而是可以相辅相成，比如：在中心化的平台上使用用去中心化的交易方式。关于中心化与去中心化，映射到现实，就类似于专制与民主，值得深思与探讨。（参考肖老师课程最后一节）</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Vt411X7JF" title="北京大学肖臻老师《区块链技术与应用》公开课_哔哩哔哩_bilibili">北京大学肖臻老师《区块链技术与应用》公开课_哔哩哔哩_bilibili</a></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://ethereum.org/zh/whitepaper/" title="Ethereum Whitepaper | ethereum.org">Ethereum Whitepaper | ethereum.org</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/[Chinese-Simplified]-Ethereum-%E7%99%BD%E7%9A%AE%E4%B9%A6%E4%B8%AD%E6%96%87%E7%89%88" title="[Chinese Simplified] Ethereum 白皮书中文版 · ethereum/wiki Wiki (github.com)">[Chinese Simplified] Ethereum 白皮书中文版 · ethereum&#x2F;wiki Wiki (github.com)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://ethereum.org/zh/developers/docs/" title="以太坊开发文档 | ethereum.org">以太坊开发文档 | ethereum.org</a></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/BlockChain/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B9%8BGFS.html" rel="prev" title="分布式之GFS">
                  <i class="fa fa-chevron-left"></i> 分布式之GFS
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E6%AF%94%E7%89%B9%E5%B8%81%E4%B8%AD%E7%9A%84%E9%87%8D%E9%9A%BE%E7%82%B9.html" rel="next" title="比特币中的重难点">
                  比特币中的重难点 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dounine</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">537k</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"99MyCql/99MyCql.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
